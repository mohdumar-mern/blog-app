{% extends 'layout.html' %}
{% load static %}

{% block title %}{{ post.title }} | MySite{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
{% endblock %}

{% block content %}
<section class="post-detail">

    <article class="post-detail-card">

        <!-- üîπ Post Header -->
        <header class="post-header">
            <h1 class="post-detail-title">{{ post.title }}</h1>

            <div class="post-meta">
                <span class="post-author">
                    By {{ post.author.get_username }}
                </span>

                <time datetime="{{ post.created_at|date:'Y-m-d' }}"
                      class="post-date">
                    {{ post.created_at|date:"F d, Y" }}
                </time>
            </div>
        </header>

        <!-- üîπ Post Banner -->
        {% if post.banner %}
        <figure class="post-image">
            <img src="{{ post.banner.url }}" alt="{{ post.title }}">
        </figure>
        {% endif %}

        <!-- üîπ Post Content -->
        <div class="post-content">
            {{ post.body|linebreaks }}
        </div>

        <!-- üîπ Footer -->
        <footer class="post-footer">
            <a href="{% url 'posts:list' %}" class="back-btn">
                ‚Üê Back to Posts
            </a>
        </footer>

        <hr class="divider">

        <section class="comments-section">
            <h3 class="comments-title">
                {{ comments.count }} Comments
            </h3>
            {% comment %} Firstly check user is login and Add Comment  {% endcomment %}
            {% if user.is_authenticated %}
                <form method="POST" class="comment-form">
                    {% csrf_token %}
                    {{ form.body }}
                    <button type="submit" class="btn-comment">
                        Comment
                    </button>
                </form>
            {% else %}
                <p class="login-msg">
                    Please <a href="{% url 'users:login' %}">login</a> to comment.
                </p>
            {% endif %}

            <div class="comments-list">
            {% for comment in comments %}
                <div class="comment">
                    <div class="comment-header">
                            <strong>{{ comment.user.username }}</strong>
                            <span>{{ comment.created_at|date:"M d, Y" }}</span>
                    </div>
                        <p>{{ comment.body | linebreaks}}</p>

                        <!-- Reply button -->
                        <a href="#" onclick="showReplyForm({{ comment.id }})">Reply</a>

                        <!-- Replies -->
                     {% if comment.replies.count > 0 %}
                        <button
                            class="toggle-replies"
                            data-target="replies-{{ comment.id }}"
                            data-count="{{ comment.replies.count }}">
                            Show Replies ({{ comment.replies.count }})
                        </button>

                        <div class="replies"
                            id="replies-{{ comment.id }}"
                            style="display:none; margin-left:20px;">

                            {% for reply in comment.replies.all %}
                                {% if reply.is_active %}
                                    <div class="comment-reply">
                                       <div class="comment-header">
                                         <strong>{{ reply.user.username }}</strong>
                                        <span>{{ reply.created_at|date:"M d, Y" }}</span>
                                       </div>
                                      
                                        <p>{{ reply.body|linebreaks }}</p>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                   

                        <!-- Reply form -->
                        <form method="POST" class="comment-form" id="reply-form-{{ comment.id }}" style="display:none;">
                            {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">

                            {{ form.body }}
                            <button type="submit" class="btn-comment">
                                Reply
                            </button>
                        </form>
                </div>
            {% endfor %}
            
            </div>

        </section>






    </article>

</section>
{% endblock %}


{% block extra_js %}
<script src="{% static 'js/reply-toggle.js' %}"></script>
{% endblock %}
